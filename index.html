const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1WfO2nUQjS6SembeQuv5eQLTVHtUUFBE5jgfVSmdGbhc/edit?gid=0#gid=0'; // 👈 Ganti dengan URL Sheet kamu
const SHEET_NAME = 'Data';
const HARGA_KURSUS = 99000;
const ADMIN_WA = '62881012056464'; // 👈 Ganti WA Admin
const WEB_APP_DOMAIN = 'https://idm-001.github.io'; // 👈 Ganti dengan domain website kamu

//---------------------------------------------------------------
// 🔹 handleOptions - Menangani pre-flight request untuk CORS
//---------------------------------------------------------------
function handleOptions() {
  return ContentService.createTextOutput('')
    .withHeaders({
      'Access-Control-Allow-Origin': WEB_APP_DOMAIN,
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    });
}

//---------------------------------------------------------------
// 🔹 doPost - Dipanggil saat form dikirim
//---------------------------------------------------------------
function doPost(e) {
  if (e.postData.type === 'application/x-www-form-urlencoded' && e.parameter.method === 'OPTIONS') {
    return handleOptions();
  }
  
  try {
    const data = JSON.parse(e.postData.contents);

    const nama = (data.nama || '').trim();
    const email = (data.email || '').trim().toLowerCase();
    // Perbaikan: Ganti 0 di depan dengan 62, jika tidak ada 62, tambahkan 62.
    let wa = (data.wa || '').replace(/\D/g, '');
    if (wa.startsWith('0')) {
      wa = '62' + wa.substring(1);
    } else if (!wa.startsWith('62')) {
      wa = '62' + wa;
    }

    if (!nama || !email || !wa) {
      return createJsonResponse({ result: 'error', message: 'Semua field wajib diisi.' });
    }

    const ss = SpreadsheetApp.openByUrl(SHEET_URL);
    const sheet = ss.getSheetByName(SHEET_NAME);
    const rows = sheet.getDataRange().getValues();
    const headers = rows[0];

    // Menggunakan Map untuk efisiensi
    const headerMap = new Map(headers.map((h, i) => [h, i]));
    const requiredHeaders = ['Order ID', 'Nama', 'Email', 'WhatsApp', 'Status', 'Harga', 'Timestamp'];
    
    // Validasi semua header yang dibutuhkan ada
    for (const header of requiredHeaders) {
      if (!headerMap.has(header)) {
        console.error('Kolom tidak ditemukan:', header);
        return createJsonResponse({ result: 'error', message: `Struktur sheet tidak valid, kolom "${header}" tidak ditemukan.` });
      }
    }

    const idxEmail = headerMap.get('Email');
    const idxWa = headerMap.get('WhatsApp');

    const orderId = generateOrderId();
    let foundRowIndex = -1;

    // Cari data yang sudah ada
    for (let i = 1; i < rows.length; i++) {
      const rowEmail = (rows[i][idxEmail] || '').toString().trim().toLowerCase();
      const rowWa = (rows[i][idxWa] || '').toString().replace(/\D/g, '');
      if (rowEmail === email || rowWa === wa) {
        foundRowIndex = i;
        break;
      }
    }

    let resultMessage = '';

    if (foundRowIndex > 0) {
      const rowNumber = foundRowIndex + 1;
      const range = sheet.getRange(rowNumber, 1, 1, headers.length);
      const rowData = range.getValues()[0];
      rowData[headerMap.get('Order ID')] = orderId;
      rowData[headerMap.get('Status')] = 'Belum Bayar';
      rowData[headerMap.get('Timestamp')] = new Date();
      range.setValues([rowData]);
      resultMessage = `Data ditemukan, diperbarui dengan Order ID baru: ${orderId}`;
    } else {
      const newRow = new Array(headers.length).fill('');
      newRow[headerMap.get('Order ID')] = orderId;
      newRow[headerMap.get('Nama')] = nama;
      newRow[headerMap.get('Email')] = email;
      newRow[headerMap.get('WhatsApp')] = wa;
      newRow[headerMap.get('Status')] = 'Belum Bayar';
      newRow[headerMap.get('Harga')] = HARGA_KURSUS;
      newRow[headerMap.get('Timestamp')] = new Date();
      sheet.appendRow(newRow);
      resultMessage = `Data baru berhasil ditambahkan dengan Order ID: ${orderId}`;
    }

    const tagihanInfo = generateTagihanInfo();
    
    const tagihanMsg = encodeURIComponent(
      `Halo ${nama}, terima kasih telah mendaftar! 🎉\n\n` +
      `📝 *Order ID: ${orderId}*\n` +
      `📧 Email: ${email}\n` +
      `📱 WhatsApp: ${wa}\n` +
      `💰 *Tagihan: Rp${HARGA_KURSUS.toLocaleString('id-ID')}*\n\n` +
      `Silakan transfer ke salah satu rekening berikut:\n` +
      `${tagihanInfo}\n\n` +
      `Setelah transfer, konfirmasi ke admin via WhatsApp ini dengan mengirim bukti transfer.\n\n` +
      `Harap sabar, akan dikonfirmasi secepatnya. Terima kasih!`
    );

    const adminMsg = encodeURIComponent(
      `🔔 *NOTIFIKASI PENDAFTARAN BARU*\n\n` +
      `Nama: ${nama}\n` +
      `Email: ${email}\n` +
      `WA: ${wa}\n` +
      `Order ID: ${orderId}\n` +
      `Status: Belum Bayar\n` +
      `Waktu: ${new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })}\n\n`+
      `Hubungi pendaftar: https://wa.me/${wa}` // Link langsung ke pendaftar
    );

    const buyerWaLink = `https://wa.me/${ADMIN_WA}?text=${tagihanMsg}`;
    const adminWaLink = `https://wa.me/${ADMIN_WA}?text=${adminMsg}`; // Notif ke admin

    return createJsonResponse({
      result: 'success',
      orderId: orderId,
      name: nama,
      email: email,
      wa: wa,
      message: resultMessage,
      buyerWaLink: buyerWaLink,
      adminWaLink: adminWaLink, // Kirim link notif admin juga (opsional, untuk debug)
      tagihan: tagihanInfo,
      harga: `Rp${HARGA_KURSUS.toLocaleString('id-ID')}`
    });

  } catch (error) {
    console.error('Error di doPost:', error.toString(), error.stack);
    return createJsonResponse({ result: 'error', message: 'Terjadi kesalahan sistem. Coba lagi nanti.' });
  }
}

//---------------------------------------------------------------
// 🔹 Fungsi Pembantu
//---------------------------------------------------------------
function createJsonResponse(data) {
  const response = ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
  response.setHeaders({
    'Access-Control-Allow-Origin': WEB_APP_DOMAIN,
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
  });
  return response;
}

function generateTagihanInfo() {
  return `💳 *GOPAY/DANA/SHOPEEPAY/OVO:*\n   081322273798\n` +
         `💳 *BRI:*\n   328901030233537\n` +
         `💳 *BCA:*\n   8105790712\n` +
         `💳 *BSI:*\n   7153465147\n` +
         `💳 *MANDIRI:*\n   1300020963156`;
}

function generateOrderId() {
  const date = new Date();
  const dateStr = Utilities.formatDate(date, 'Asia/Jakarta', 'yyyyMMdd');
  const random = Math.floor(100 + Math.random() * 900); // 3 digit angka random
  return `ORD-${dateStr}-${random}`;
}

// Sisa fungsi (doGet, onOpen, setStatusToPaid, testGenerateOrderId) tetap sama

// ... (Salin sisa fungsi dari kode asli ke sini)

function doGet(e) {
  return HtmlService.createHtmlOutput(`
    <p>Halo! Ini adalah endpoint untuk proses checkout kursus.</p>
    <p>Silakan gunakan form di website untuk mendaftar.</p>
    <p><small>Error "Fungsi skrip tidak ditemukan" muncul karena Anda mengakses langsung URL Web App.</small></p>
  `);
}

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('🔧 Kursus Tools')
    .addItem('Set Status: Sudah Bayar', 'setStatusToPaid')
    .addToUi();
}

function setStatusToPaid() {
  const sheet = SpreadsheetApp.getActiveSheet();
  const selection = sheet.getActiveRange();
  const row = selection.getRow();

  if (row === 1) {
    SpreadsheetApp.getUi().alert('⚠️ Tidak bisa mengubah header!');
    return;
  }

  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const statusCol = headers.indexOf('Status') + 1;

  if (statusCol === 0) {
    SpreadsheetApp.getUi().alert('Kolom "Status" tidak ditemukan!');
    return;
  }

  sheet.getRange(row, statusCol).setValue('Sudah Bayar');
  SpreadsheetApp.getUi().alert(`✅ Status baris ${row} diubah menjadi "Sudah Bayar"`);
}

function testGenerateOrderId() {
  console.log(generateOrderId());
}
